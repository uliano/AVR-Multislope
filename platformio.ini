; PlatformIO Project Configuration File
;
; AVR128DA48 Multislope Project
; - Bare metal (no framework)
; - GCC 15.2 (Zak Kemble build)
; - Serial on UART2 (PF4/PF5)
;
; https://github.com/ZakKemble/avr-gcc-build/

[platformio]
default_envs = Upload_UPDI

[env]
platform = atmelmegaavr
board = AVR128DA48

; GCC 15.2 from Zak Kemble - latest version
platform_packages =
    toolchain-atmelavr @ file://C:/Users/uliano/stuff/toolchains/avr-gcc-15.2.0/avr-gcc-15.2.0-x64-windows

; Build flags
build_flags =
    -Wall
    -Wextra
    -Os
    -g  ; Debug symbols for source-level disassembly
    -DF_CPU=24000000UL  ; Clock frequency
    -D__AVR_AVR128DA48__  ; MCU define for IntelliSense (GCC adds this via -mmcu)
    ;-DSERIAL_PORT=Serial2  ; Use UART2 like MPLABX project
    -Wl,-Map,firmware.map  ; Generate linker map file

; Extra scripts: pre-build for toolchain paths, post-build for disassembly
extra_scripts =
    pre:add_toolchain_paths.py
    post:generate_lst.py

; Serial monitor settings
monitor_speed = 115200
monitor_port = COM8
; monitor_port = t sts
; monitor_dtr = 1
; monitor_rts = 1

; UPDI upload via serial adapter
[env:Upload_UPDI]
upload_protocol = atmelice_updi
;upload_port = COM4
;upload_speed = 115200
; Use avrdude 8.1 from Zak Kemble toolchain instead of PlatformIO's old 7.1.0
; upload_command = C:/Users/uliano/stuff/toolchains/avr-gcc-15.2.0/avr-gcc-15.2.0-x64-windows/bin/avrdude.exe -C C:/Users/uliano/stuff/toolchains/avr-gcc-15.2.0/avr-gcc-15.2.0-x64-windows/bin/avrdude.conf -p $BOARD_MCU -c serialupdi -P $UPLOAD_PORT -b $UPLOAD_SPEED -U flash:w:$SOURCE:i
upload_command = C:/Users/uliano/stuff/toolchains/avr-gcc-15.2.0/avr-gcc-15.2.0-x64-windows/bin/avrdude.exe -C C:/Users/uliano/stuff/toolchains/avr-gcc-15.2.0/avr-gcc-15.2.0-x64-windows/bin/avrdude.conf -p $BOARD_MCU -c atmelice_updi -U flash:w:$SOURCE:i

; UART upload (if bootloader is present)
[env:Upload_UART]
upload_protocol = arduino
upload_port = COM4
upload_speed = 115200

[env:Upload_AtmelICE]
upload_protocol = atmelice_updi

; Fuses configuration (bare metal, no bootloader)
[env:set_fuses]
upload_protocol = serialupdi
upload_port = COM4
board_fuses.WDTCFG = 0x00    ; Watchdog disabled
board_fuses.BODCFG = 0x00    ; BOD disabled
board_fuses.OSCCFG = 0x02    ; 24MHz internal oscillator
board_fuses.SYSCFG0 = 0xC8   ; EESAVE=no, RESET pin, no CRC
board_fuses.SYSCFG1 = 0x07   ; 64ms startup time
board_fuses.CODESIZE = 0x00  ; Full flash for application
board_fuses.BOOTSIZE = 0x00  ; No bootloader section
